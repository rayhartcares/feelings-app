import React, { useState, useEffect, useRef, useCallback } from 'react';

// --- Sound Engine (Web Audio API) ---
const SoundEngine = {
  ctx: null,
  bgNodes: [], 
  bgInterval: null,
  isBgPlaying: false,
  currentTrack: 'titanic', // Default set to Titanic

  init: function() {
    if (!this.ctx) {
      this.ctx = new (window.AudioContext || window.webkitAudioContext)();
    }
  },

  // --- MASTER MUSIC CONTROL ---
  playMusic: function(style) {
    if (this.ctx && this.ctx.state === 'suspended') return;
    
    this.stopBackgroundMusic(); 
    this.currentTrack = style;
    this.isBgPlaying = true;

    if (style === 'chandelier') this.playChandelier();
    else if (style === 'happy') this.playHappy();
    else if (style === 'anthem') this.playAnthem();
    else if (style === 'dontspeak') this.playDontSpeak();
    else if (style === 'jw') this.playJW();
    else if (style === 'goodnews') this.playGoodNews();
    else if (style === 'sun') this.playSun();
    else if (style === 'titanic') this.playTitanic();
  },

  stopBackgroundMusic: function() {
    if (this.bgInterval) {
        clearInterval(this.bgInterval);
        this.bgInterval = null;
    }
    this.bgNodes.forEach(node => {
        try {
            if (node.stop) node.stop();
            node.disconnect();
        } catch (e) {}
    });
    this.bgNodes = [];
    this.isBgPlaying = false;
  },

  // --- TRACK 1: "Chandelier" (Synth-Pop) ---
  playChandelier: function() {
    if (!this.ctx) this.init();
    let step = 0;
    const stepTime = 0.176; 
    const chords = [[233.08, 277.18, 349.23], [185.00, 233.08, 277.18], [277.18, 349.23, 415.30], [207.65, 261.63, 311.13]];

    this.bgInterval = setInterval(() => {
        const now = this.ctx.currentTime;
        const currentStepInLoop = step % 32;
        const chordIndex = Math.floor(currentStepInLoop / 8);
        const localStep = currentStepInLoop % 8;

        if (localStep === 0 || localStep === 3 || localStep === 6) {
            chords[chordIndex].forEach((freq, i) => {
                const osc = this.ctx.createOscillator(); const gain = this.ctx.createGain();
                osc.type = 'triangle'; osc.frequency.setValueAtTime(freq + (i * 1.5), now); 
                gain.gain.setValueAtTime(0.06, now); gain.gain.exponentialRampToValueAtTime(0.001, now + 0.4);
                osc.connect(gain); gain.connect(this.ctx.destination); osc.start(); osc.stop(now + 0.5);
            });
        }
        if (localStep === 0) { 
            const osc = this.ctx.createOscillator(); const gain = this.ctx.createGain();
            osc.frequency.setValueAtTime(150, now); osc.frequency.exponentialRampToValueAtTime(0.01, now + 0.5);
            gain.gain.setValueAtTime(0.4, now); gain.gain.exponentialRampToValueAtTime(0.001, now + 0.5);
            osc.connect(gain); gain.connect(this.ctx.destination); osc.start(); osc.stop(now + 0.5);
        }
        if (localStep === 4) {
            const bufferSize = this.ctx.sampleRate * 0.2; const buffer = this.ctx.createBuffer(1, bufferSize, this.ctx.sampleRate);
            const data = buffer.getChannelData(0); for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
            const noise = this.ctx.createBufferSource(); noise.buffer = buffer;
            const noiseGain = this.ctx.createGain(); noiseGain.gain.setValueAtTime(0.2, now); noiseGain.gain.exponentialRampToValueAtTime(0.001, now + 0.2);
            noise.connect(noiseGain); noiseGain.connect(this.ctx.destination); noise.start();
            const osc = this.ctx.createOscillator(); const gain = this.ctx.createGain(); osc.type = 'triangle';
            osc.frequency.setValueAtTime(200, now); gain.gain.setValueAtTime(0.1, now); gain.gain.exponentialRampToValueAtTime(0.001, now + 0.1);
            osc.connect(gain); gain.connect(this.ctx.destination); osc.start(); osc.stop(now + 0.2);
        }
        if (localStep === 0 && chordIndex === 0) {
             const osc = this.ctx.createOscillator(); const gain = this.ctx.createGain(); osc.type = 'sawtooth';
             osc.frequency.setValueAtTime(698.46, now); 
             const filter = this.ctx.createBiquadFilter(); filter.type = 'lowpass'; filter.frequency.setValueAtTime(800, now);
             gain.gain.setValueAtTime(0, now); gain.gain.linearRampToValueAtTime(0.03, now + 2); gain.gain.linearRampToValueAtTime(0, now + 5.6);
             osc.connect(filter); filter.connect(gain); gain.connect(this.ctx.destination); osc.start(); osc.stop(now + 5.6);
        }
        step++;
    }, 176); 
  },

  // --- TRACK 2: "Happy Day" (Upbeat Marimba) ---
  playHappy: function() {
    if (!this.ctx) this.init();
    const melody = [523.25, 659.25, 783.99, 880.00, 1046.50, 880.00, 783.99, 659.25];
    let noteIndex = 0;

    this.bgInterval = setInterval(() => {
        const now = this.ctx.currentTime;
        const freq = melody[noteIndex];
        const osc = this.ctx.createOscillator(); const gain = this.ctx.createGain();
        osc.type = 'triangle'; osc.frequency.setValueAtTime(freq, now);
        gain.gain.setValueAtTime(0.05, now); gain.gain.exponentialRampToValueAtTime(0.001, now + 0.2);
        osc.connect(gain); gain.connect(this.ctx.destination); osc.start(); osc.stop(now + 0.25);

        if (noteIndex % 4 === 0) {
            const bassOsc = this.ctx.createOscillator(); const bassGain = this.ctx.createGain(); bassOsc.type = 'sine';
            bassOsc.frequency.setValueAtTime(noteIndex === 0 ? 130.81 : 196.00, now);
            bassGain.gain.setValueAtTime(0.05, now); bassGain.gain.exponentialRampToValueAtTime(0.001, now + 0.4);
            bassOsc.connect(bassGain); bassGain.connect(this.ctx.destination); bassOsc.start(); bassOsc.stop(now + 0.5);
        }
        noteIndex = (noteIndex + 1) % melody.length;
    }, 250); 
  },

  // --- TRACK 3: "This Is Me" (Anthem Stomp) ---
  playAnthem: function() {
    if (!this.ctx) this.init();
    let step = 0;
    const chords = [[293.66, 369.99, 440.00], [246.94, 293.66, 369.99], [196.00, 246.94, 293.66], [220.00, 277.18, 329.63]];
    const bassRoots = [73.42, 61.74, 49.00, 55.00];

    this.bgInterval = setInterval(() => {
        const now = this.ctx.currentTime;
        const chordIndex = Math.floor((step % 64) / 16);
        const localStep = step % 16;

        if (localStep === 0 || localStep === 12) {
            chords[chordIndex].forEach((freq) => {
                const osc = this.ctx.createOscillator(); const gain = this.ctx.createGain();
                osc.type = 'sawtooth'; osc.frequency.setValueAtTime(freq, now); osc.detune.value = (Math.random() * 10) - 5;
                const filter = this.ctx.createBiquadFilter(); filter.type = 'lowpass'; filter.frequency.value = 800;
                gain.gain.setValueAtTime(0.04, now); gain.gain.exponentialRampToValueAtTime(0.001, now + 1.5);
                osc.connect(filter); filter.connect(gain); gain.connect(this.ctx.destination); osc.start(); osc.stop(now + 1.6);
            });
            const bassOsc = this.ctx.createOscillator(); const bassGain = this.ctx.createGain();
            bassOsc.type = 'triangle'; bassOsc.frequency.setValueAtTime(bassRoots[chordIndex], now);
            bassGain.gain.setValueAtTime(0.1, now); bassGain.gain.exponentialRampToValueAtTime(0.001, now + 1.0);
            bassOsc.connect(bassGain); bassGain.connect(this.ctx.destination); bassOsc.start(); bassOsc.stop(now + 1.0);
        }
        if (localStep === 0 || localStep === 3 || localStep === 8 || localStep === 11) {
            const osc = this.ctx.createOscillator(); const gain = this.ctx.createGain();
            osc.frequency.setValueAtTime(100, now); osc.frequency.exponentialRampToValueAtTime(0.01, now + 0.4);
            gain.gain.setValueAtTime(0.3, now); gain.gain.exponentialRampToValueAtTime(0.001, now + 0.4);
            osc.connect(gain); gain.connect(this.ctx.destination); osc.start(); osc.stop(now + 0.4);
        }
        if (localStep === 4 || localStep === 12) {
            const bufferSize = this.ctx.sampleRate * 0.15; const buffer = this.ctx.createBuffer(1, bufferSize, this.ctx.sampleRate);
            const data = buffer.getChannelData(0); for (let i = 0; i < bufferSize; i++) data[i] = (Math.random() * 2 - 1) * (1 - i/bufferSize);
            const noise = this.ctx.createBufferSource(); noise.buffer = buffer;
            const filter = this.ctx.createBiquadFilter(); filter.type = 'bandpass'; filter.frequency.value = 1200;
            const gain = this.ctx.createGain(); gain.gain.setValueAtTime(0.15, now);
            noise.connect(filter); filter.connect(gain); gain.connect(this.ctx.destination); noise.start();
        }
        step++;
    }, 130); 
  },

  // --- TRACK 4: "Don't Speak" (Chorus Version) ---
  playDontSpeak: function() {
    if (!this.ctx) this.init();
    let step = 0;
    const Cm = [261.63, 311.13, 392.00]; const Fm = [174.61, 207.65, 261.63]; 
    const Bb = [233.08, 293.66, 349.23]; const Eb_Bb = [311.13, 392.00, 466.16]; 
    const bassSequence = [65.41, 43.65, 58.27, 77.78]; 

    this.bgInterval = setInterval(() => {
        const now = this.ctx.currentTime;
        const currentStepInLoop = step % 32; const chordIndex = Math.floor(currentStepInLoop / 8); const localStep = currentStepInLoop % 8;
        
        let currentChord = Cm;
        if (chordIndex === 1) currentChord = Fm;
        if (chordIndex === 2) currentChord = Bb;
        if (chordIndex === 3) currentChord = (localStep < 4) ? Eb_Bb : Bb; 

        if (localStep % 2 === 0) { 
            const noteIndex = (localStep / 2) % 3;
            const freq = currentChord[noteIndex];
            const osc = this.ctx.createOscillator(); const gain = this.ctx.createGain();
            osc.type = 'sawtooth'; osc.frequency.setValueAtTime(freq, now);
            const filter = this.ctx.createBiquadFilter(); filter.type = 'lowpass';
            filter.frequency.setValueAtTime(2000, now); filter.frequency.exponentialRampToValueAtTime(100, now + 0.3); 
            gain.gain.setValueAtTime(0.06, now); gain.gain.exponentialRampToValueAtTime(0.001, now + 0.5); 
            osc.connect(filter); filter.connect(gain); gain.connect(this.ctx.destination); osc.start(); osc.stop(now + 0.6);
        }
        if (localStep === 0) {
            let bassFreq = bassSequence[chordIndex]; if (chordIndex === 3) bassFreq = 77.78; 
            const osc = this.ctx.createOscillator(); const gain = this.ctx.createGain();
            osc.type = 'sawtooth'; osc.frequency.setValueAtTime(bassFreq, now);
            const filter = this.ctx.createBiquadFilter(); filter.type = 'lowpass'; filter.frequency.value = 200; 
            gain.gain.setValueAtTime(0, now); gain.gain.linearRampToValueAtTime(0.1, now + 0.5); gain.gain.linearRampToValueAtTime(0, now + 1.6); 
            osc.connect(filter); filter.connect(gain); gain.connect(this.ctx.destination); osc.start(); osc.stop(now + 1.6);
        }
        if (chordIndex === 3 && localStep === 4) {
             const osc = this.ctx.createOscillator(); const gain = this.ctx.createGain();
             osc.type = 'sawtooth'; osc.frequency.setValueAtTime(58.27, now); 
             const filter = this.ctx.createBiquadFilter(); filter.type = 'lowpass'; filter.frequency.value = 200;
             gain.gain.setValueAtTime(0, now); gain.gain.linearRampToValueAtTime(0.1, now + 0.2); gain.gain.linearRampToValueAtTime(0, now + 0.8);
             osc.connect(filter); filter.connect(gain); gain.connect(this.ctx.destination); osc.start(); osc.stop(now + 0.8);
        }
        step++;
    }, 200); 
  },

  // --- TRACK 5: "Best Life" (Acoustic Pop) ---
  playJW: function() {
    if (!this.ctx) this.init();
    let step = 0;
    const chords = [[196.00, 246.94, 293.66], [146.83, 185.00, 220.00], [164.81, 196.00, 246.94], [130.81, 164.81, 196.00]];
    const bass = [98.00, 73.42, 82.41, 65.41]; 

    this.bgInterval = setInterval(() => {
        const now = this.ctx.currentTime;
        const currentStepInLoop = step % 32; const chordIndex = Math.floor(currentStepInLoop / 8); const localStep = currentStepInLoop % 8;

        if (localStep % 2 === 0) {
            chords[chordIndex].forEach((freq, i) => {
                const osc = this.ctx.createOscillator(); const gain = this.ctx.createGain();
                osc.type = 'triangle'; osc.frequency.setValueAtTime(freq, now + (i * 0.03)); 
                gain.gain.setValueAtTime(0.05, now); gain.gain.exponentialRampToValueAtTime(0.001, now + 0.4);
                osc.connect(gain); gain.connect(this.ctx.destination); osc.start(now + (i * 0.03)); osc.stop(now + 0.5);
            });
        }
        if (localStep === 0 || localStep === 4) {
            const osc = this.ctx.createOscillator(); const gain = this.ctx.createGain();
            osc.type = 'sine'; osc.frequency.setValueAtTime(chords[chordIndex][1] * 2, now); 
            gain.gain.setValueAtTime(0.03, now); gain.gain.exponentialRampToValueAtTime(0.001, now + 0.6);
            osc.connect(gain); gain.connect(this.ctx.destination); osc.start(); osc.stop(now + 0.7);
        }
        if (localStep === 0) {
            const osc = this.ctx.createOscillator(); const gain = this.ctx.createGain();
            osc.type = 'triangle'; osc.frequency.setValueAtTime(bass[chordIndex], now);
            gain.gain.setValueAtTime(0.08, now); gain.gain.exponentialRampToValueAtTime(0.001, now + 1.8); 
            osc.connect(gain); gain.connect(this.ctx.destination); osc.start(); osc.stop(now + 1.9);
        }
        step++;
    }, 250);
  },

  // --- TRACK 6: "Good News" (Cinematic Orchestral) ---
  playGoodNews: function() {
    if (!this.ctx) this.init();
    let step = 0;
    const chords = [[311.13, 392.00, 466.16], [233.08, 293.66, 349.23], [261.63, 311.13, 392.00], [207.65, 261.63, 311.13]];
    const bassRoots = [77.78, 58.27, 65.41, 51.91]; 

    this.bgInterval = setInterval(() => {
        const now = this.ctx.currentTime;
        const currentStepInLoop = step % 16; const chordIndex = Math.floor(currentStepInLoop / 4); const localStep = currentStepInLoop % 4;

        if (localStep === 0) {
            const notes = chords[chordIndex];
            notes.forEach((freq, i) => {
                const osc = this.ctx.createOscillator(); const gain = this.ctx.createGain();
                osc.type = 'sawtooth'; osc.frequency.setValueAtTime(freq, now); osc.detune.value = (i === 1) ? 5 : -5; 
                const filter = this.ctx.createBiquadFilter(); filter.type = 'lowpass'; filter.frequency.value = 600; 
                gain.gain.setValueAtTime(0, now); gain.gain.linearRampToValueAtTime(0.05, now + 1.0); gain.gain.linearRampToValueAtTime(0.03, now + 3.0); gain.gain.linearRampToValueAtTime(0, now + 3.9); 
                osc.connect(filter); filter.connect(gain); gain.connect(this.ctx.destination); osc.start(); osc.stop(now + 4.0);
            });
            const bassOsc = this.ctx.createOscillator(); const bassGain = this.ctx.createGain();
            bassOsc.type = 'triangle'; bassOsc.frequency.setValueAtTime(bassRoots[chordIndex], now);
            const bassFilter = this.ctx.createBiquadFilter(); bassFilter.type = 'lowpass'; bassFilter.frequency.value = 150;
            bassGain.gain.setValueAtTime(0.2, now); bassGain.gain.exponentialRampToValueAtTime(0.001, now + 2.0); 
            bassOsc.connect(bassFilter); bassFilter.connect(bassGain); bassGain.connect(this.ctx.destination);
            bassOsc.start(); bassOsc.stop(now + 2.0);
        }
        if (localStep === 0 || localStep === 2) {
            const osc = this.ctx.createOscillator(); const gain = this.ctx.createGain();
            osc.type = 'sawtooth'; const note = (localStep === 0) ? chords[chordIndex][0] / 2 : chords[chordIndex][2] / 2; 
            osc.frequency.setValueAtTime(note, now);
            const filter = this.ctx.createBiquadFilter(); filter.type = 'lowpass'; filter.frequency.value = 400; 
            gain.gain.setValueAtTime(0, now); gain.gain.linearRampToValueAtTime(0.04, now + 0.2); gain.gain.linearRampToValueAtTime(0, now + 1.5);
            osc.connect(filter); filter.connect(gain); gain.connect(this.ctx.destination); osc.start(); osc.stop(now + 1.5);
        }
        step++;
    }, 800); 
  },

  // --- TRACK 7: "Here Comes The Sun" (Acoustic Folk) ---
  playSun: function() {
    if (!this.ctx) this.init();
    let step = 0;
    const stepTime = 0.23;
    const A_Maj = [220.00, 277.18, 329.63]; const D_Maj = [293.66, 369.99, 440.00]; const E_Maj = [329.63, 415.30, 493.88];

    this.bgInterval = setInterval(() => {
        const now = this.ctx.currentTime;
        const currentStepInLoop = step % 24; const chordIndex = Math.floor(currentStepInLoop / 8); const localStep = currentStepInLoop % 8;
        let note = 0; let chord = [];
        if (chordIndex === 0) { chord = A_Maj; const pattern = [0, 2, 1, 2, 0, 2, 1, 2]; note = chord[pattern[localStep]]; }
        else if (chordIndex === 1) { 
            chord = D_Maj; const pattern = [1, 2, 1, 0, 1, 2, 1, 0]; note = chord[pattern[localStep]]; 
            if (localStep === 0) note = 369.99; if (localStep === 2) note = 329.63; if (localStep === 4) note = 293.66; 
        } else { chord = E_Maj; const pattern = [0, 2, 1, 2, 0, 2, 1, 2]; note = chord[pattern[localStep]]; }

        const osc = this.ctx.createOscillator(); const gain = this.ctx.createGain();
        osc.type = 'sawtooth'; osc.frequency.setValueAtTime(note, now);
        const filter = this.ctx.createBiquadFilter(); filter.type = 'lowpass'; filter.frequency.setValueAtTime(3000, now); filter.frequency.exponentialRampToValueAtTime(100, now + 0.2);
        gain.gain.setValueAtTime(0.06, now); gain.gain.exponentialRampToValueAtTime(0.001, now + 0.3);
        osc.connect(filter); filter.connect(gain); gain.connect(this.ctx.destination); osc.start(); osc.stop(now + 0.3);

        if (localStep === 0 || localStep === 4) {
            const synthOsc = this.ctx.createOscillator(); const synthGain = this.ctx.createGain();
            synthOsc.type = 'triangle'; synthOsc.frequency.setValueAtTime(note * 2, now); 
            synthGain.gain.setValueAtTime(0, now); synthGain.gain.linearRampToValueAtTime(0.03, now + 0.1); synthGain.gain.linearRampToValueAtTime(0, now + 0.4);
            synthOsc.connect(synthGain); synthGain.connect(this.ctx.destination); synthOsc.start(); synthOsc.stop(now + 0.5);
        }
        step++;
    }, stepTime * 1000);
  },

  // --- TRACK 8: "Titanic" (Cinematic Flute) ---
  playTitanic: function() {
    if (!this.ctx) this.init();
    let step = 0;
    const stepTime = 0.15; 
    const E4 = 329.63, Fs4 = 369.99, Gs4 = 415.30, A4 = 440.00, B4 = 493.88, B3 = 246.94;
    const melodySequence = [
        { s: 0, f: E4 }, { s: 2, f: E4 }, { s: 4, f: E4 }, { s: 6, f: E4 }, 
        { s: 8, f: B4 }, 
        { s: 12, f: A4 }, { s: 13, f: Gs4 }, { s: 14, f: Fs4 }, { s: 15, f: Gs4 }, 
        { s: 16, f: A4 }, 
        { s: 20, f: Gs4 }, { s: 22, f: Fs4 }, { s: 24, f: E4 } 
    ];

    this.bgInterval = setInterval(() => {
        const now = this.ctx.currentTime;
        const localStep = step % 32;

        const note = melodySequence.find(n => n.s === localStep);
        if (note) {
            const osc = this.ctx.createOscillator(); const gain = this.ctx.createGain();
            osc.type = 'sine'; osc.frequency.setValueAtTime(note.f, now);
            gain.gain.setValueAtTime(0, now); gain.gain.linearRampToValueAtTime(0.08, now + 0.1); gain.gain.linearRampToValueAtTime(0.06, now + 0.3); gain.gain.linearRampToValueAtTime(0, now + 0.6);
            const lfo = this.ctx.createOscillator(); lfo.frequency.value = 5; const lfoGain = this.ctx.createGain(); lfoGain.gain.value = 3;
            lfo.connect(lfoGain); lfoGain.connect(osc.frequency); lfo.start();
            osc.connect(gain); gain.connect(this.ctx.destination); osc.start(); osc.stop(now + 0.7);
        }

        if (localStep === 0 || localStep === 16) {
            const root = (localStep === 0) ? E4 : B3; const third = (localStep === 0) ? Gs4 : 311.13; const fifth = (localStep === 0) ? B4 : Fs4;
            [root/2, third/2, fifth/2].forEach(freq => { 
                const osc = this.ctx.createOscillator(); const gain = this.ctx.createGain();
                osc.type = 'sawtooth'; osc.frequency.setValueAtTime(freq, now);
                const filter = this.ctx.createBiquadFilter(); filter.type = 'lowpass'; filter.frequency.value = 400; 
                gain.gain.setValueAtTime(0, now); gain.gain.linearRampToValueAtTime(0.05, now + 1); gain.gain.linearRampToValueAtTime(0, now + (stepTime * 16));
                osc.connect(filter); filter.connect(gain); gain.connect(this.ctx.destination); osc.start(); osc.stop(now + (stepTime * 16));
            });
        }
        step++;
    }, stepTime * 1000);
  },

  // --- SFX Synthesizer (Shared) ---
  playTone: function(freq, type, duration, volume = 0.1) {
    if (!this.ctx) this.init();
    const osc = this.ctx.createOscillator(); const gain = this.ctx.createGain();
    osc.type = type; osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
    gain.gain.setValueAtTime(volume, this.ctx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);
    osc.connect(gain); gain.connect(this.ctx.destination); osc.start(); osc.stop(this.ctx.currentTime + duration);
  },
  playNoise: function(duration, volume = 0.2) {
    if (!this.ctx) this.init();
    const bufferSize = this.ctx.sampleRate * duration; const buffer = this.ctx.createBuffer(1, bufferSize, this.ctx.sampleRate);
    const data = buffer.getChannelData(0); for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
    const noise = this.ctx.createBufferSource(); noise.buffer = buffer;
    const gain = this.ctx.createGain(); gain.gain.setValueAtTime(volume, this.ctx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);
    noise.connect(gain); gain.connect(this.ctx.destination); noise.start();
  },

  // --- SFX Patches ---
  playClick: function() { this.playTone(800, 'sine', 0.1, 0.1); },
  playStart: function() { this.playTone(400, 'triangle', 0.3, 0.1); }, 
  playSuccess: function() { setTimeout(() => this.playTone(523.25, 'sine', 0.6, 0.1), 0); setTimeout(() => this.playTone(659.25, 'sine', 0.6, 0.1), 100); setTimeout(() => this.playTone(783.99, 'sine', 0.8, 0.1), 200); },
  playWhoosh: function() { this.playNoise(0.3, 0.1); },
  playCrash: function() { this.playNoise(0.5, 0.3); },
  playMeltdown: function() { this.playTone(150, 'sawtooth', 0.4, 0.2); },
  playYell: function() { this.playTone(300, 'sawtooth', 0.6, 0.2); },
  playWalkAway: function() { this.playTone(200, 'square', 0.1, 0.05); setTimeout(() => this.playTone(300, 'square', 0.1, 0.05), 100); },
  playBreathIn: function() { this.playNoise(1.5, 0.05); },
  playBreathOut: function() { this.playNoise(1.5, 0.05); }
};

// --- Sub-Components ---
const ActionScene = ({ type, character, playSound }) => {
  const charEmoji = character === 'boy' ? 'üò†' : 'üò°';
  useEffect(() => {
    if (type === 'throw') { playSound('throw_whoosh'); setTimeout(() => playSound('throw_crash'), 800); } 
    else if (type === 'meltdown') { playSound('meltdown'); }
  }, [type, playSound]);

  if (type === 'throw') return (
      <div className="relative w-full h-full flex items-center justify-center overflow-hidden bg-red-50 rounded-3xl">
        <div className="text-8xl absolute left-4 bottom-4 z-10">{charEmoji}</div>
        <div className="absolute text-6xl animate-throw">üß∏</div>
        <div className="absolute right-4 top-10 text-6xl animate-pulse delay-700">üí•</div>
        <style>{`@keyframes throw { 0% { transform: translate(-100px, 50px) rotate(0deg); opacity: 0; } 20% { opacity: 1; } 80% { transform: translate(120px, -50px) rotate(360deg); opacity: 1; } 100% { transform: translate(140px, -40px) rotate(380deg); opacity: 0; } } .animate-throw { animation: throw 1.5s infinite linear; }`}</style>
      </div>
  );
  if (type === 'meltdown') return (
      <div className="relative w-full h-full flex items-center justify-center overflow-hidden bg-red-50 rounded-3xl">
        <div className="text-8xl animate-tantrum origin-bottom">üò´</div>
        <div className="absolute top-1/4 left-1/4 text-4xl animate-bounce delay-100">üí¶</div>
        <div className="absolute top-1/3 right-1/4 text-4xl animate-bounce delay-300">üíß</div>
        <div className="absolute top-4 text-5xl animate-pulse">‚ö°</div>
        <style>{`@keyframes tantrum { 0% { transform: rotate(90deg) translateX(0px); } 25% { transform: rotate(85deg) translateX(-5px); } 50% { transform: rotate(95deg) translateX(5px); } 75% { transform: rotate(85deg) translateX(-5px); } 100% { transform: rotate(90deg) translateX(0px); } } .animate-tantrum { animation: tantrum 0.3s infinite linear; }`}</style>
      </div>
  );
  return null;
};

// --- CUSTOM SVG FOR WELCOME SCREEN (COLORFUL ANGRY KID) ---
// Redesigned to look YOUNGER (neoteny features: bigger eyes, larger forehead, softer chin)
const ColorfulAngryBoySVG = () => {
  return (
    <svg viewBox="0 0 200 200" className="w-64 h-64 animate-shake origin-bottom">
      {/* Dynamic Background Burst */}
      <path d="M100,10 L115,35 L140,25 L130,50 L155,60 L130,75 L145,100 L120,100 L120,130 L100,110 L80,130 L80,100 L55,100 L70,75 L45,60 L70,50 L60,25 L85,35 Z"
            fill="#FFEBEE" stroke="#FFCDD2" strokeWidth="2" className="animate-pulse-fast" />

      {/* Steam */}
      <path d="M40,60 Q20,40 50,30" fill="none" stroke="#CFD8DC" strokeWidth="4" className="animate-steam-left" opacity="0.8" strokeLinecap="round" />
      <path d="M160,60 Q180,40 150,30" fill="none" stroke="#CFD8DC" strokeWidth="4" className="animate-steam-right" opacity="0.8" strokeLinecap="round" />

      {/* Tiny Body (emphasizes big head = child) */}
      <path d="M70,170 Q100,180 130,170 V200 H70 Z" fill="#42A5F5" stroke="#1976D2" strokeWidth="2" />

      {/* Head - Big Circle for Child proportions */}
      <circle cx="100" cy="100" r="70" fill="#FFCCBC" stroke="#E64A19" strokeWidth="2" />

      {/* Furious Flush Gradient */}
      <defs>
        <radialGradient id="childFlush" cx="50%" cy="50%" r="50%">
          <stop offset="0%" stopColor="#FF5252" stopOpacity="0.6" />
          <stop offset="90%" stopColor="#FFCCBC" stopOpacity="0" />
        </radialGradient>
      </defs>
      <circle cx="100" cy="100" r="60" fill="url(#childFlush)" />

      {/* Ears - Lower for cute/young look */}
      <circle cx="30" cy="105" r="10" fill="#FFCCBC" stroke="#E64A19" strokeWidth="2" />
      <circle cx="170" cy="105" r="10" fill="#FFCCBC" stroke="#E64A19" strokeWidth="2" />

      {/* Hair - Messy/Spiky Kid Hair */}
      <path d="M35,85 Q30,30 100,25 Q170,30 165,85 Q150,60 100,55 Q50,60 35,85" fill="#5D4037" stroke="#3E2723" strokeWidth="2" />
      {/* Bangs */}
      <path d="M100,55 Q90,75 80,60 Q70,80 60,65" fill="none" stroke="#5D4037" strokeWidth="2" />

      {/* Eyebrows - Very angled, but thicker/shorter */}
      <path d="M65,85 L90,100" stroke="#3E2723" strokeWidth="6" strokeLinecap="round" />
      <path d="M135,85 L110,100" stroke="#3E2723" strokeWidth="6" strokeLinecap="round" />

      {/* Eyes - Large circles (Childlike) but squashed by brows */}
      <path d="M70,105 Q80,120 90,105" fill="#FFF" stroke="#3E2723" strokeWidth="1" /> {/* Squinted bottom */}
      <path d="M110,105 Q120,120 130,105" fill="#FFF" stroke="#3E2723" strokeWidth="1" />
      <circle cx="80" cy="108" r="4" fill="#3E2723" />
      <circle cx="120" cy="108" r="4" fill="#3E2723" />

      {/* Mouth - Screaming (Rounded Rect) */}
      <rect x="75" y="125" width="50" height="25" rx="8" fill="#B71C1C" stroke="#3E2723" strokeWidth="2" />
      <path d="M85,145 Q100,135 115,145" fill="none" stroke="#E57373" strokeWidth="3" strokeLinecap="round" /> {/* Tongue */}
      
      {/* Tears (Optional: Flying out - adds to "tantrum" feel which is very kid-like) */}
      <circle cx="55" cy="115" r="3" fill="#4FC3F7" className="animate-ping" />
      <circle cx="145" cy="115" r="3" fill="#4FC3F7" className="animate-ping" style={{animationDelay: '0.5s'}} />

      <style>{`
        .animate-shake { animation: shake 0.2s infinite; }
        .animate-pulse-fast { animation: pulse 0.3s infinite; }
        .animate-steam-left { animation: steam 0.8s infinite linear; }
        .animate-steam-right { animation: steam 0.8s infinite linear reverse; }
        
        @keyframes shake {
          0% { transform: translate(1px, 1px) rotate(0deg); }
          50% { transform: translate(-1px, -2px) rotate(-2deg); }
          100% { transform: translate(-1px, 1px) rotate(2deg); }
        }
        @keyframes steam {
          0% { opacity: 0; transform: translateY(5px) scale(0.5); }
          50% { opacity: 0.8; transform: translateY(-10px) scale(1); }
          100% { opacity: 0; transform: translateY(-25px) scale(1.5); }
        }
      `}</style>
    </svg>
  );
};

// --- Coping Tool Intro Component ---
const ToolIntro = ({ tool, onStart, onBack }) => {
  return (
    <div className={`flex flex-col h-full justify-between items-center text-center p-4 rounded-3xl ${tool.intro.bgColor || 'bg-white'}`}>
      <div className="w-full flex justify-start mb-2">
        <button onClick={onBack} className="text-gray-500 text-sm font-bold">‚¨Ö Back</button>
      </div>
      
      <h2 className="text-2xl font-bold text-gray-800 mb-4">{tool.intro.title || tool.name}</h2>
      
      <div className="text-9xl mb-6 animate-bounce-slow">{tool.intro.emoji}</div>
      
      <div className="bg-white/80 p-4 rounded-xl backdrop-blur-sm mb-4">
        <p className="text-lg font-medium text-gray-700 leading-snug">{tool.intro.desc}</p>
      </div>

      <div className="bg-blue-50 p-4 rounded-xl border-2 border-blue-100 mb-4 text-left w-full">
        <h3 className="text-sm font-bold text-blue-600 mb-1">üî¨ Why it works:</h3>
        <p className="text-sm text-gray-600 leading-relaxed">{tool.intro.science}</p>
      </div>

      <button 
        onClick={onStart}
        className={`w-full py-4 text-white font-bold text-xl rounded-xl shadow-lg transform transition hover:scale-105 ${tool.intro.btnColor || 'bg-blue-500'}`}
      >
        Start Tool ‚ñ∂
      </button>
    </div>
  );
};

const ToolSequence = ({ tool, step, onRestart, onNext, playSound }) => {
  const currentStepData = tool.steps[step - 1];
  const isLongContent = currentStepData.emoji.length > 5;

  useEffect(() => { if (currentStepData && currentStepData.sound) playSound(currentStepData.sound); }, [step, currentStepData, playSound]);
  return (
    <div className="flex flex-col h-full justify-between items-center text-center p-2">
      <div className="w-full flex justify-between items-center mb-2">
        <h2 className="text-xl font-bold text-green-700">{tool.name}</h2>
        <span className="px-3 py-1 bg-green-200 text-green-800 rounded-full text-sm font-bold">Step {step}/3</span>
      </div>
      <div className="flex-1 flex flex-col justify-center items-center w-full overflow-hidden">
         <div className={`${isLongContent ? 'text-6xl tracking-widest' : 'text-9xl'} mb-6 transform transition-all hover:scale-110 duration-500 cursor-default`}>
            {currentStepData.emoji}
         </div>
         <p className="text-xl text-gray-700 font-medium px-4 bg-green-50 py-6 rounded-2xl w-full border border-green-100">{currentStepData.text}</p>
      </div>
      <div className="w-full flex gap-3 mt-4">
        <button onClick={onRestart} className="flex-1 py-3 bg-gray-200 text-gray-600 font-bold rounded-xl hover:bg-gray-300">Restart</button>
        <button onClick={onNext} className="flex-2 w-2/3 py-3 bg-green-500 text-white font-bold rounded-xl shadow-lg hover:bg-green-600">{step === 3 ? 'Finish!' : 'Next Step ‚û°Ô∏è'}</button>
      </div>
    </div>
  );
};

const App = () => {
  const [currentView, setCurrentView] = useState('welcome');
  const [character, setCharacter] = useState('boy'); 
  const [activeTab, setActiveTab] = useState('negative');
  const [soundEnabled, setSoundEnabled] = useState(true);
  const [musicStyle, setMusicStyle] = useState('titanic'); 
  
  const [currentTool, setCurrentTool] = useState(null);
  const [toolStep, setToolStep] = useState(1);

  // --- Sound Logic Wrapper ---
  const playSound = useCallback((key) => {
    if (!soundEnabled) return;
    try {
        if (SoundEngine.ctx && SoundEngine.ctx.state === 'suspended') {
            SoundEngine.ctx.resume();
        }
        
        // Handle Music
        if (key === 'start' || key === 'click' || key === 'music_change') {
          SoundEngine.playMusic(musicStyle);
        }

        if (key !== 'music_change') {
            switch(key) {
                case 'click': SoundEngine.playClick(); break;
                case 'start': SoundEngine.playStart(); break;
                case 'success': SoundEngine.playSuccess(); break;
                case 'throw_whoosh': SoundEngine.playWhoosh(); break;
                case 'throw_crash': SoundEngine.playCrash(); break;
                case 'meltdown': SoundEngine.playMeltdown(); break;
                case 'yell': SoundEngine.playYell(); break;
                case 'walkaway': SoundEngine.playWalkAway(); break;
                case 'breath_in': SoundEngine.playBreathIn(); break;
                case 'breath_out': SoundEngine.playBreathOut(); break;
                default: break;
            }
        }
    } catch (e) {
        console.error("Sound Engine Error:", e);
    }
  }, [soundEnabled, musicStyle]);

  const safePlay = (key) => playSound(key);

  // --- Music Cycler ---
  const cycleMusic = () => {
      const styles = ['chandelier', 'happy', 'anthem', 'dontspeak', 'jw', 'goodnews', 'sun', 'titanic'];
      const nextIndex = (styles.indexOf(musicStyle) + 1) % styles.length;
      const nextStyle = styles[nextIndex];
      setMusicStyle(nextStyle);
      // Immediate effect
      if (soundEnabled) {
          if (SoundEngine.ctx && SoundEngine.ctx.state === 'suspended') SoundEngine.ctx.resume();
          SoundEngine.playMusic(nextStyle);
      }
  };

  const getMusicLabel = () => {
      if (musicStyle === 'chandelier') return 'Pop üé§';
      if (musicStyle === 'happy') return 'Happy ‚òÄÔ∏è';
      if (musicStyle === 'anthem') return 'Anthem ü•Å';
      if (musicStyle === 'dontspeak') return 'Sad üé∏';
      if (musicStyle === 'jw') return 'Acoustic üìñ';
      if (musicStyle === 'goodnews') return 'Epic üéª';
      if (musicStyle === 'sun') return 'Sun ‚òÄÔ∏è';
      if (musicStyle === 'titanic') return 'Titanic üö¢';
  };

  const negativeReactions = {
    throw: { type: 'throw', title: 'Throwing Things', scene: null, desc: 'Oh no! Throwing toys makes a big mess and might break something special.', bgColor: 'bg-red-100', btnColor: 'bg-red-500' },
    yell: { type: 'emoji', emoji: 'üó£Ô∏è', title: 'Yelling Loudly', scene: 'üì¢üò´üëÇ', desc: 'Yelling hurts people\'s ears and makes them feel sad or scared.', bgColor: 'bg-orange-100', btnColor: 'bg-orange-500' },
    meltdown: { type: 'meltdown', emoji: 'üò≠', title: 'Having a Meltdown', scene: null, desc: 'Crying on the floor makes it hard to use your words to fix the problem.', bgColor: 'bg-red-50', btnColor: 'bg-red-400' },
    walkaway: { type: 'emoji', emoji: 'üò§', title: 'Stomping Away', scene: 'üö™üèÉüí®', desc: 'Running away doesn\'t fix the problem. The problem is still there when you come back.', bgColor: 'bg-gray-100', btnColor: 'bg-gray-500' }
  };

  const copingTools = {
    balloon: { 
        id: 'balloon', 
        name: 'Balloon Breathing', 
        intro: {
            emoji: 'üéà',
            title: 'Balloon Breathing',
            desc: 'Pretend there is a big balloon in your tummy. Let\'s fill it up with air!',
            science: 'Deep breathing signals your brain to calm down by activating the parasympathetic nervous system. It lowers your heart rate and helps you think clearly.',
            bgColor: 'bg-blue-50',
            btnColor: 'bg-blue-500'
        },
        steps: [
            { emoji: 'üéàüò§', text: 'Imagine a balloon in your tummy. Take a big breath in through your nose to fill it up!', sound: 'breath_in' },
            { emoji: '‚úãüõë', text: 'Hold that breath for 3 seconds. 1... 2... 3...', sound: null },
            { emoji: 'üå¨Ô∏èüí®', text: 'Now let the air out slowly through your mouth. Whoosh!', sound: 'breath_out' }
        ]
    },
    squeeze: { 
        id: 'squeeze', 
        name: 'Stress Squeeze',
        intro: {
            emoji: 'üß∏',
            title: 'Stress Squeeze',
            desc: 'Use your muscles to squeeze out all the angry feelings!',
            science: 'Progressive Muscle Relaxation (PMR) helps release physical tension that builds up when we are angry. Squeezing and releasing muscles tells your body it is safe to relax.',
            bgColor: 'bg-purple-50',
            btnColor: 'bg-purple-500'
        },
        steps: [
            { emoji: 'üß∏‚úä', text: 'Find a soft toy or a pillow, or just clasp your hands together.', sound: 'click' },
            { emoji: 'üí™üò´', text: 'Squeeze all your muscles TIGHT! Count to 5!', sound: 'click' },
            { emoji: 'üòå‚ú®', text: 'Let go and relax your body like a cooked noodle.', sound: 'breath_out' }
        ]
    },
    walk: { 
        id: 'walk', 
        name: 'Safe Walk',
        intro: {
            emoji: 'üö∂‚Äç‚ôÇÔ∏è',
            title: 'Safe Walk',
            desc: 'Move your body to a safe place to cool down.',
            science: 'Removing yourself from the situation (the trigger) stops the immediate stress response. Walking also burns off the extra adrenaline ("fight or flight" energy) produced by anger.',
            bgColor: 'bg-green-50',
            btnColor: 'bg-green-500'
        },
        steps: [
            { emoji: 'üõëüëÄ', text: 'Stop what you are doing. Look for a safe place.', sound: 'click' },
            { emoji: 'üö∂‚Äç‚ôÇÔ∏èüå≥', text: 'Walk slowly to your safe spot or a window.', sound: 'walkaway' },
            { emoji: 'üëÄü¶ã', text: 'Find 3 things that are blue or green to look at.', sound: 'success' }
        ]
    },
    count: { 
        id: 'count', 
        name: 'Count to 10',
        intro: {
            emoji: 'üî¢',
            title: 'Count to 10',
            desc: 'Slow down your brain by counting slowly to ten.',
            science: 'Counting requires focus and concentration. This distracts your brain from the angry thoughts and gives your "impulse control" center time to catch up before you act.',
            bgColor: 'bg-indigo-50',
            btnColor: 'bg-indigo-500'
        },
        steps: [
            // Added spaces between numbers to ensure they don't get cut off
            { emoji: '1Ô∏è‚É£ 2Ô∏è‚É£ 3Ô∏è‚É£', text: 'Close your eyes. Start counting slowly. One... Two... Three...', sound: 'click' },
            { emoji: '4Ô∏è‚É£ 5Ô∏è‚É£ 6Ô∏è‚É£', text: 'Keep going. Take a breath between each number. Four... Five... Six...', sound: 'click' },
            { emoji: '7Ô∏è‚É£ 8Ô∏è‚É£ 9Ô∏è‚É£ üîü', text: 'Almost there! Seven... Eight... Nine... Ten! Open your eyes.', sound: 'success' }
        ]
    }
  };

  const handleStart = () => { safePlay('start'); setCurrentView('character'); };
  const selectCharacter = (char) => { safePlay('click'); setCharacter(char); setCurrentView('trigger'); };
  const handleReactionClick = (reactionKey) => { 
    if(reactionKey === 'yell') safePlay('yell'); if(reactionKey === 'walkaway') safePlay('walkaway');
    setCurrentView(`negative_${reactionKey}`); 
  };
  const handleToolClick = (toolKey) => { 
      safePlay('click'); 
      setCurrentTool(toolKey); 
      setToolStep(1);
      setCurrentView('tool_intro'); 
  };
  const startToolSequence = () => {
      safePlay('click');
      setCurrentView('tool_sequence');
  };

  const nextToolStep = () => {
    if (toolStep < 3) { setToolStep(prev => prev + 1); } else { safePlay('success'); setCurrentView('reflection'); }
  };
  const restartTool = () => { safePlay('click'); setToolStep(1); };
  const restartApp = () => { safePlay('start'); setCurrentView('welcome'); setCharacter('boy'); setActiveTab('negative'); setCurrentTool(null); setToolStep(1); };
  const handleExit = () => { safePlay('click'); SoundEngine.stopBackgroundMusic(); setCurrentView('session_ended'); };
  const goBack = () => {
    safePlay('click');
    if (currentView === 'character') setCurrentView('welcome');
    else if (currentView === 'trigger') setCurrentView('character');
    else if (currentView === 'menu') setCurrentView('trigger');
    else if (currentView.startsWith('negative_')) setCurrentView('menu');
    else if (currentView === 'tool_intro') setCurrentView('menu'); 
    else if (currentView === 'tool_sequence') { setCurrentView('tool_intro'); setToolStep(1); } 
    else if (currentView === 'reflection') setCurrentView('menu');
    else if (currentView === 'restart') setCurrentView('reflection');
    else if (currentView === 'goodbye') setCurrentView('welcome');
  };

  const toggleSound = () => {
      const newState = !soundEnabled;
      setSoundEnabled(newState);
      if (newState) {
          if (SoundEngine.ctx && SoundEngine.ctx.state === 'suspended') SoundEngine.ctx.resume();
          if (currentView !== 'session_ended') SoundEngine.playMusic(musicStyle);
      } else { SoundEngine.stopBackgroundMusic(); }
  };

  const renderWelcome = () => (
    <div className="flex flex-col items-center justify-center h-full text-center space-y-8 animate-fadeIn">
      <div className="space-y-2"><h1 className="text-4xl font-black text-red-500 tracking-wider">Brave Feelings Lab</h1><h2 className="text-2xl font-bold text-red-400">Emotion Navigator ‚Äì ANGRY</h2></div>
      
      {/* REPLACED STATIC EMOJI WITH COLORFUL ANGRY BOY SVG */}
      <ColorfulAngryBoySVG />

      <button onClick={handleStart} className="px-10 py-4 bg-red-500 text-white text-2xl font-bold rounded-full shadow-lg hover:bg-red-600 hover:scale-105 transition-all transform border-b-8 border-red-700 active:border-b-0 active:translate-y-2">START</button>
    </div>
  );
  const renderGoodbye = () => (
    <div className="flex flex-col items-center justify-center h-full text-center space-y-6 animate-fadeIn">
      <div className="text-9xl animate-bounce">üëã</div><h2 className="text-3xl font-black text-blue-500">See you next time!</h2>
      <p className="text-xl text-gray-600 font-medium">Remember to take deep breaths.</p>
      <button onClick={restartApp} className="mt-8 px-8 py-3 bg-green-500 text-white text-xl font-bold rounded-full shadow-lg hover:bg-green-600">Start Over</button>
    </div>
  );
  const renderSessionEnded = () => (
    <div className="flex flex-col items-center justify-center h-full text-center space-y-6 bg-slate-900 text-white animate-fadeIn absolute inset-0 z-50">
      <div className="text-8xl mb-4 grayscale opacity-80">üåô</div><h2 className="text-3xl font-bold text-blue-200">Goodnight!</h2>
      <p className="text-xl text-gray-400">The Brave Feelings Lab is closed for now.</p>
      <button onClick={restartApp} className="mt-12 px-8 py-3 border-2 border-gray-600 text-gray-400 font-bold rounded-full hover:bg-gray-800 hover:text-white transition flex items-center gap-2"><span>üîå</span> Turn On</button>
    </div>
  );
  const renderCharacter = () => (
    <div className="flex flex-col items-center h-full text-center space-y-8 p-4">
      <h2 className="text-3xl font-bold text-gray-700">Who is playing today?</h2>
      <div className="flex justify-center gap-8 w-full">
        <div className="flex flex-col items-center space-y-4"><div className="text-8xl bg-blue-100 p-6 rounded-3xl border-4 border-blue-300">üë¶</div><button onClick={() => selectCharacter('boy')} className="px-6 py-3 bg-blue-500 text-white font-bold rounded-xl shadow-md hover:bg-blue-600 transition">Use Boy</button></div>
        <div className="flex flex-col items-center space-y-4"><div className="text-8xl bg-pink-100 p-6 rounded-3xl border-4 border-pink-300">üëß</div><button onClick={() => selectCharacter('girl')} className="px-6 py-3 bg-pink-500 text-white font-bold rounded-xl shadow-md hover:bg-pink-600 transition">Use Girl</button></div>
      </div>
    </div>
  );
  const renderTrigger = () => (
    <div className="flex flex-col items-center h-full text-center justify-between py-6">
      <h2 className="text-2xl font-bold text-gray-700">Uh Oh! Something happened!</h2>
      <div className="bg-white p-8 rounded-3xl shadow-xl border-4 border-gray-200 w-full max-w-sm"><div className="text-8xl mb-4">üß∏‚û°Ô∏èüíî</div><div className="text-6xl absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 opacity-20 pointer-events-none">‚ö°</div></div>
      <p className="text-xl font-medium text-gray-600 px-6 bg-yellow-50 p-4 rounded-xl border border-yellow-200">You were playing with your favorite toy, but it suddenly broke! Now you feel a hot fire in your tummy. You are ANGRY!</p>
      <div className="flex gap-4 w-full px-6"><button onClick={() => setCurrentView('character')} className="flex-1 py-3 bg-gray-300 text-gray-700 font-bold rounded-xl">Back</button><button onClick={() => setCurrentView('menu')} className="flex-1 py-3 bg-red-500 text-white font-bold rounded-xl shadow-lg hover:bg-red-600">Next</button></div>
    </div>
  );
  const renderMenu = () => (
    <div className="flex flex-col h-full">
      <div className="text-center mb-4"><h2 className="text-2xl font-bold text-gray-800">What will you do?</h2><p className="text-gray-500">Tap a button to see what happens.</p></div>
      <div className="flex bg-gray-200 p-1 rounded-2xl mb-4">
        <button onClick={() => { safePlay('click'); setActiveTab('negative'); }} className={`flex-1 py-3 rounded-xl font-bold transition-all ${activeTab === 'negative' ? 'bg-white shadow text-red-500' : 'text-gray-500'}`}>Negative Reactions</button>
        <button onClick={() => { safePlay('click'); setActiveTab('coping'); }} className={`flex-1 py-3 rounded-xl font-bold transition-all ${activeTab === 'coping' ? 'bg-white shadow text-green-500' : 'text-gray-500'}`}>Coping Tools</button>
      </div>
      <div className="flex-1 overflow-y-auto">
        {activeTab === 'negative' ? (
          <div className="grid grid-cols-2 gap-4">
            <button onClick={() => handleReactionClick('throw')} className="bg-red-50 p-4 rounded-2xl border-2 border-red-200 flex flex-col items-center hover:bg-red-100 transition"><span className="text-5xl mb-2">üí•</span><span className="font-bold text-red-600">Throw</span></button>
            <button onClick={() => handleReactionClick('yell')} className="bg-red-50 p-4 rounded-2xl border-2 border-red-200 flex flex-col items-center hover:bg-red-100 transition"><span className="text-5xl mb-2">üò°</span><span className="font-bold text-red-600">Yell</span></button>
            <button onClick={() => handleReactionClick('meltdown')} className="bg-red-50 p-4 rounded-2xl border-2 border-red-200 flex flex-col items-center hover:bg-red-100 transition"><span className="text-5xl mb-2">üò≠</span><span className="font-bold text-red-600">Meltdown</span></button>
            <button onClick={() => handleReactionClick('walkaway')} className="bg-red-50 p-4 rounded-2xl border-2 border-red-200 flex flex-col items-center hover:bg-red-100 transition"><span className="text-5xl mb-2">üò§</span><span className="font-bold text-red-600">Walk Away</span></button>
          </div>
        ) : (
          <div className="grid grid-cols-2 gap-4">
            <button onClick={() => handleToolClick('balloon')} className="bg-green-50 p-4 rounded-2xl border-2 border-green-200 flex flex-col items-center hover:bg-green-100 transition"><span className="text-5xl mb-2">üéà</span><span className="font-bold text-green-600">Balloon Breath</span></button>
            <button onClick={() => handleToolClick('squeeze')} className="bg-green-50 p-4 rounded-2xl border-2 border-green-200 flex flex-col items-center hover:bg-green-100 transition"><span className="text-5xl mb-2">üß∏</span><span className="font-bold text-green-600">Stress Squeeze</span></button>
            <button onClick={() => handleToolClick('walk')} className="bg-green-50 p-4 rounded-2xl border-2 border-green-200 flex flex-col items-center hover:bg-green-100 transition"><span className="text-5xl mb-2">üö∂‚Äç‚ôÇÔ∏è</span><span className="font-bold text-green-600">Safe Walk</span></button>
            <button onClick={() => handleToolClick('count')} className="bg-indigo-50 p-4 rounded-2xl border-2 border-indigo-200 flex flex-col items-center hover:bg-indigo-100 transition"><span className="text-5xl mb-2">üî¢</span><span className="font-bold text-indigo-600">Count to 10</span></button>
          </div>
        )}
      </div>
    </div>
  );
  const renderNegativeOutcome = (type) => {
    const data = negativeReactions[type];
    const content = (data.type === 'throw' || data.type === 'meltdown') ? <ActionScene type={data.type} character={character} playSound={playSound} /> : <span className="text-8xl">{data.scene}</span>;
    return (
      <div className={`flex flex-col h-full justify-between items-center text-center p-4 rounded-3xl ${data.bgColor}`}>
        <h2 className="text-2xl font-bold text-gray-800">{data.title}</h2><div className="bg-white p-4 rounded-3xl shadow-lg h-56 w-56 flex items-center justify-center border-4 border-gray-100 overflow-hidden relative">{content}</div><div className="bg-white/80 p-4 rounded-xl backdrop-blur-sm"><p className="text-lg font-medium text-gray-700 leading-snug">{data.desc}</p></div>
        <div className="w-full space-y-3"><button onClick={() => { safePlay('click'); setCurrentView('menu'); }} className="w-full py-3 bg-white text-gray-700 font-bold rounded-xl border-2 border-gray-300 hover:bg-gray-50">Try Another Reaction</button><button onClick={() => { safePlay('success'); setActiveTab('coping'); setCurrentView('menu'); }} className="w-full py-4 bg-green-500 text-white font-bold rounded-xl shadow-lg hover:bg-green-600 animate-pulse">Go to Coping Tools ‚ú®</button></div>
      </div>
    );
  };
  const renderReflection = () => (
    <div className="flex flex-col items-center justify-center h-full text-center space-y-6 animate-fadeIn">
      <h2 className="text-3xl font-black text-green-600">Great Job!</h2><div className="relative"><div className="text-9xl animate-bounce-slow">üòä</div><div className="absolute top-0 right-0 text-6xl animate-pulse">‚ú®</div></div><div className="bg-green-50 p-6 rounded-2xl border-2 border-green-200 mx-2"><p className="text-xl text-gray-700 font-medium">You felt angry, but you used a tool to calm down. Now your brain is ready to play again!</p></div>
      <div className="w-full space-y-3">
        <button onClick={() => { safePlay('click'); setCurrentView('menu'); setActiveTab('coping'); }} className="w-full py-3 bg-white text-green-700 font-bold text-xl rounded-xl border-2 border-green-300 hover:bg-green-50">Try Another Tool</button>
        <button onClick={() => { safePlay('click'); setCurrentView('restart'); }} className="w-full py-4 bg-blue-500 text-white text-xl font-bold rounded-xl shadow-lg hover:bg-blue-600 animate-pulse">Continue</button>
      </div>
    </div>
  );
  const renderRestart = () => (
    <div className="flex flex-col items-center justify-center h-full text-center space-y-6">
      <h2 className="text-2xl font-bold text-gray-800">What would you like to do?</h2><button onClick={restartApp} className="w-full max-w-xs py-4 bg-red-500 text-white text-xl font-bold rounded-2xl shadow-lg hover:bg-red-600 transform hover:scale-105 transition">Restart ANGRY üò°</button><button onClick={handleExit} className="w-full max-w-xs py-4 bg-purple-500 text-white text-xl font-bold rounded-2xl shadow-lg hover:bg-purple-600 transform hover:scale-105 transition opacity-90">Exit / All Done üëã</button>
    </div>
  );

  return (
    <div className="min-h-screen bg-sky-100 flex items-center justify-center p-4 font-sans">
      <div className="w-full max-w-md h-[800px] max-h-[90vh] bg-white rounded-[40px] shadow-2xl overflow-hidden border-8 border-white ring-4 ring-sky-200 relative">
        {currentView !== 'session_ended' && (
          <div className="bg-slate-100 p-3 flex items-center justify-between border-b border-gray-200">
            <div className="flex gap-2 w-32">
              {currentView !== 'welcome' && currentView !== 'goodbye' && (<><button onClick={goBack} className="px-3 py-1 bg-white rounded-full shadow-sm text-gray-600 font-bold text-sm hover:bg-gray-100 transition flex items-center gap-1">‚¨ÖÔ∏è Back</button><button onClick={restartApp} className="px-3 py-1 bg-white rounded-full shadow-sm text-gray-600 font-bold text-sm hover:bg-gray-100 transition flex items-center gap-1">üè† Home</button></>)}
            </div>
            <div className="flex flex-col items-center"><span className="font-bold text-gray-400 text-xs truncate hidden sm:block">Brave Feelings Lab</span>
            {/* MUSIC SELECTOR */}
            <button onClick={cycleMusic} className="mt-1 px-2 py-0.5 bg-blue-50 text-blue-600 text-xs font-bold rounded-full hover:bg-blue-100 transition border border-blue-200">üéµ {getMusicLabel()}</button>
            </div>
            <div className="w-32 flex justify-end gap-2">
               <button onClick={toggleSound} className={`px-3 py-1 rounded-full shadow-sm font-bold text-sm transition ${soundEnabled ? 'bg-blue-100 text-blue-600 hover:bg-blue-200' : 'bg-gray-200 text-gray-400'}`}>{soundEnabled ? 'üîä' : 'üîá'}</button>
              {currentView !== 'welcome' && currentView !== 'goodbye' && (<button onClick={handleExit} className="px-3 py-1 bg-red-100 text-red-600 rounded-full shadow-sm font-bold text-sm hover:bg-red-200 transition">Exit ‚ùå</button>)}
            </div>
          </div>
        )}
        <div className="h-full p-6 pb-20 overflow-y-auto relative">
          {currentView === 'welcome' && renderWelcome()} {currentView === 'character' && renderCharacter()} {currentView === 'trigger' && renderTrigger()} {currentView === 'menu' && renderMenu()} {currentView.startsWith('negative_') && renderNegativeOutcome(currentView.replace('negative_', ''))}
          
          {/* NEW: Tool Intro Page */}
          {currentView === 'tool_intro' && (
              <ToolIntro 
                tool={copingTools[currentTool]} 
                onStart={startToolSequence}
                onBack={() => setCurrentView('menu')}
              />
          )}

          {currentView === 'tool_sequence' && (<ToolSequence tool={copingTools[currentTool]} step={toolStep} onRestart={restartTool} onNext={nextToolStep} playSound={playSound}/>)}
          {currentView === 'reflection' && renderReflection()} {currentView === 'restart' && renderRestart()} {currentView === 'goodbye' && renderGoodbye()} {currentView === 'session_ended' && renderSessionEnded()}
        </div>
      </div>
      <style>{`@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } } .animate-fadeIn { animation: fadeIn 0.5s ease-out forwards; } .animate-bounce-slow { animation: bounce 2s infinite; }`}</style>
    </div>
  );
};

export default App;
